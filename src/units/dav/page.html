<!DOCTYPE html>

<head>
  <meta name="viewport" content="width=device-width" />
  <link rel="icon" href="data:" />
  <title>Dav - ksite</title>
</head>

<style>
  * {
    appearance: none;
    margin: 0;
    font: 14px / 20px sans-serif;
    color: #000;
    background: #fff;
  }
  @media (prefers-color-scheme: dark) {
    * {
      color: #fff;
      background: #000;
    }
  }
  body {
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header > *,
  header ~ * {
    padding: 8px 10px;
    border: 0 solid #888;
    outline: 0;
  }
  header > * {
    float: left;
    border-right-width: 1px;
  }
  header > :active {
    background: #8887;
  }
  header ~ * {
    font-family: monospace;
    border-top-width: 1px;
  }
  textarea {
    flex: 1;
    white-space: pre;
  }
  input[type="checkbox"] {
    width: 14px;
    height: 14px;
    border: 3px solid #0000;
    box-shadow: 0 0 0 1px #888;
    vertical-align: middle;
  }
  input[type="checkbox"]:checked {
    box-shadow: 0 0 0 1px #888, inset 0 0 0 8px #888;
  }
  table {
    padding: 4px 0;
  }
  td {
    padding: 4px 8px;
    text-wrap: nowrap;
  }
  html:not([stage_auth_], [stage_list_], [stage_edit_]) {
    display: none;
  }
  html[stage_auth_] header > :not([stage_auth_]),
  html[stage_auth_] header ~ :not([stage_auth_]),
  html[stage_list_] header > :not([stage_list_]),
  html[stage_list_] header ~ :not([stage_list_]),
  html[stage_edit_] header > :not([stage_edit_]),
  html[stage_edit_] header ~ :not([stage_edit_]) {
    display: none;
  }
</style>

<body>
  <header>
    <button stage_auth_ id="$login">Log in</button>
    <button stage_auth_ id="$signup">Sign up</button>
    <button stage_list_ id="$logout">Log out</button>
    <button stage_list_ id="$create">Create</button>
    <button stage_list_ id="$delete">Delete</button>
    <button stage_list_ id="$flag">Flag</button>
    <button stage_edit_ id="$save">Save</button>
  </header>
  <input stage_auth_ id="$uid" placeholder="User ID" />
  <input stage_auth_ id="$upw" placeholder="Password" type="password" />
  <table stage_list_>
    <tbody id="$list"></tbody>
    <thead>
      <tr>
        <th width="1"></th>
        <th>Name</th>
        <th width="1">Size</th>
        <th width="1">Modified</th>
      </tr>
    </thead>
  </table>
  <textarea stage_edit_ id="$edit"></textarea>
</body>

<script>
  "use strict";

  // url = "https://127.0.0.1:9304/dav#/nextchat/href.txt"

  const setStage = (stage) => {
    ["stage_auth_", "stage_list_", "stage_edit_"].forEach((v) => {
      document.documentElement.removeAttribute(v);
    });
    document.documentElement.setAttribute(stage, "");
  };

  const readableSize = (v /* bytes */) => {
    let unit = "B";
    if (v >= 2 ** 40 * 1e3) throw "too big";
    else if (v >= 2 ** 30 * 1e3) (unit = "TiB"), (v /= 2 ** 40);
    else if (v >= 2 ** 20 * 1e3) (unit = "GiB"), (v /= 2 ** 30);
    else if (v >= 2 ** 10 * 1e3) (unit = "MiB"), (v /= 2 ** 20);
    else if (v >= 2 ** 0 * 1e3) (unit = "KiB"), (v /= 2 ** 10);
    v = ("" + v).slice(0, 4);
    if (v.endsWith(".")) v = v.slice(0, 3);
    return `${v} ${unit}`;
  };

  $signup.onclick = async () => {
    const r = await fetch(location, {
      method: "POST",
      headers: {
        op_: "signup",
        uid_: $uid.value,
        auth_: "Basic " + btoa($uid.value + ":" + $upw.value),
      },
    });
    if (!r.ok) throw alert(r.status);
    alert("signup successfully");
  };

  $login.onclick = async () => {
    localStorage.davAuth = "Basic " + btoa($uid.value + ":" + $upw.value);
    location.hash = "#/";
    onhashchange();
  };

  $upw.onkeypress = ({ key }) => {
    if (key === "Enter") $login.click();
  };

  $logout.onclick = async () => {
    delete localStorage.davAuth;
    location.hash = "";
    location.reload();
  };

  onhashchange = async () => {
    const pathname = location.pathname + location.hash.slice(1);
    if (pathname.endsWith("/")) {
      await asList(pathname);
      setStage("stage_list_");
    } else {
      await asEdit(pathname);
      setStage("stage_edit_");
    }
  };

  const asEdit = async (pathname) => {
    const r = await fetch(pathname, {
      method: "GET",
      headers: { authorization: localStorage.davAuth },
    });
    if (!r.ok) throw alert(r.status);
    $edit.value = await r.text();
  };

  const asList = async (pathname) => {
    const r = await fetch(pathname, {
      method: "PROPFIND",
      headers: {
        authorization: localStorage.davAuth,
        depth: "1",
        "content-type": "text/xml; charset=utf-8",
      },
      body: `<?xml version="1.0" encoding="utf-8" ?><D:propfind xmlns:D="DAV:"><D:allprop/></D:propfind>`,
    });
    if (!r.ok) throw alert(r.status);
    const resDoc = new DOMParser().parseFromString(await r.text(), "text/xml");
    let innerHTML = "";
    const select = (entry, k) => entry.querySelector(k)?.textContent;
    const entries = [...resDoc.children[0].children].sort((a, b) => {
      const an = select(a, "displayname");
      const ad = typeof select(a, "collection") === "string";
      const bn = select(b, "displayname");
      const bd = typeof select(b, "collection") === "string";
      return bd - ad || (an < bn ? -1 : bn < an ? 1 : 0);
    });
    for (const entry of entries) {
      const href = select(entry, "href");
      const displayname = select(entry, "displayname");
      const getlastmodified = select(entry, "getlastmodified");
      const getcontentlength = select(entry, "getcontentlength");
      const collection = typeof select(entry, "collection") === "string";
      innerHTML += `
        <tr>
          <td><input type=checkbox></td>
          <td data-href="${href}">${displayname + (collection ? "/" : "")}</td>
          <td>${collection ? "" : readableSize(getcontentlength)}</td>
          <td>${getlastmodified}</td>
        </tr>
      `;
    }
    $list.innerHTML = innerHTML;
  };

  $list.onclick = async (e) => {
    const href = e?.target?.dataset?.href;
    if (!href) return;
    location.hash = "#" + href.slice(location.pathname.length);
    onhashchange();
  };

  $delete.onclick = async () => {
    for (const el of $list.querySelectorAll("input[type=checkbox]:checked")) {
      const href = el?.parentElement?.nextElementSibling?.dataset?.href;
      if (!href) continue;
      const r = await fetch(href, {
        method: "DELETE",
        headers: { authorization: localStorage.davAuth },
      });
      if (!r.ok) throw alert(r.status);
    }
    onhashchange();
  };

  $create.onclick = async () => {
    const dir = location.hash.slice(1);
    if (!dir.endsWith("/")) throw alert("current must be dir");
    const entryName = prompt("file name or dir name with '/'", "new-file.txt");
    if (!entryName) return;
    const r = await fetch(location.pathname + dir + entryName, {
      method: entryName.endsWith("/") ? "MKCOL" : "PUT",
      headers: { authorization: localStorage.davAuth },
      body: "",
    });
    if (!r.ok) throw alert(r.status);
    onhashchange();
  };

  $save.onclick = async () => {
    const pathname = location.pathname + location.hash.slice(1);
    const r = await fetch(pathname, {
      method: "PUT",
      headers: { authorization: localStorage.davAuth },
      body: $edit.value,
    });
    if (!r.ok) throw alert(r.status);
    const originText = $save.textContent;
    $save.textContent = "Saved successfully";
    setTimeout(() => void ($save.textContent = originText), 1000);
  };

  if (localStorage.davAuth) {
    location.hash = location.hash || "#/";
    onhashchange();
  } else {
    setStage("stage_auth_");
  }
</script>
