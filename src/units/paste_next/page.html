<!DOCTYPE html>

<head>
  <meta name="viewport" content="width=device-width" />
  <link rel="icon" href="data:" />
  <title>Paste - ksite</title>
</head>

<style>
  * {
    box-sizing: border-box;
    margin: 0;
    transition: 0.2s cubic-bezier(0, 0, 0, 1);
    font: 14px / 18px sans-serif;
  }
  * {
    color: #000;
    background: #fff;
  }
  /* @media (prefers-color-scheme: dark) {
      * {
        color: #fff;
        background: #000;
      }
    } */

  prompt_ {
    -webkit-backdrop-filter: blur(8px);
    backdrop-filter: blur(8px);
    width: 100%;
    height: 100%;
    position: fixed;
    left: 0;
    top: 0;
    display: none;
  }

  input,
  button {
    border: 1px solid #888b; /* def: default_border */
    border-width: 0 0 1px 0;
    padding: 6px 12px;
    min-width: 0;
  }
  input:hover,
  button:hover,
  input:focus {
    background: #bbb3; /* def: button_hover_color */
  }
  button {
    border-radius: 6px;
    border-width: 1px;
  }
  button:active {
    background: #bbb6; /* def: button_active_color */
  }
  input[type="checkbox"] {
    height: 16px;
    width: 16px;
    box-shadow: inset 0 0 0 1px #ccc, inset 0 0 0 9px #fff, inset 0 0 0 9px #999;
  }
  input[type="checkbox"]:checked {
    box-shadow: inset 0 0 0 1px #ccc, inset 0 0 0 4px #fff, inset 0 0 0 9px #999;
  }

  top_bar_ {
    display: flex;
    gap: 8px;
    padding: 8px;
    border-bottom: 1px solid #8885; /* def: lite_border */
  }
  top_bar_ span {
    flex-grow: 1;
  }

  tab_launch_:not([in_]),
  tab_edit_:not([in_]),
  tab_files_:not([in_]),
  tab_settings_:not([in_]) {
    visibility: hidden;
  }

  tab_launch_,
  tab_launch_ div {
    display: grid;
    gap: 24px;
    grid: auto / 2fr 3fr;
  }
  tab_launch_ {
    width: 300px;
    margin: auto;
    margin-top: 80px;
    padding: 24px;
    border-radius: 8px;
    border: 1px solid #888b; /* ref: default_border */
  }
  tab_launch_ > input {
    grid-column: 1 / 3;
    margin-top: -4px;
  }

  tab_files_,
  tab_edit_ {
    display: grid;
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    grid: auto auto 1fr / auto;
  }
  files_list_ div {
    box-shadow: -8px 0 4px -4px #000;
    padding: 1px 10px 1px 0;
    display: flex;
    gap: 8px;
    position: absolute;
    right: 0;
    top: 0;
  }
  files_list_ table {
    border-spacing: 0;
  }
  files_list_ tr > * {
    padding: 8px 12px;
    text-align: left;
  }
  tab_files_ td:last-child:not(:hover) div {
    opacity: 0;
    visibility: hidden;
  }
  files_list_ {
    overflow: auto;
    overflow: overlay;
    display: grid;
    padding-right: 8px;
  }
  files_list_ thead tr {
    position: sticky;
    top: 0;
  }
  files_list_ tr > :first-child {
    writing-mode: vertical-rl;
    text-align: center;
    padding: 0;
    line-height: 6px;
    transform: translateX(5px);
  }

  tab_edit_ textarea {
    border: none;
    outline: none;
    padding: 8px;
    grid-row-end: 4;
    resize: none;
    font-family: monospace;
    /* place-content: ; */
  }
  tab_edit_ textarea[blank_] {
    /* because the css `:blank` pseudo have poor supports */
    /* background: #ccc; */
  }
  tab_edit_ textarea[blank_]::before {
    content: "Input text or upload file";
  }
</style>

<body>
  <tab_launch_ id="$tabLaunch" in_>
    <input id="$uid" placeholder="Username" />
    <input id="$upw" placeholder="Password" type="password" />
    <!-- <input id="$mail" placeholder="Mail" type="email" /> -->
    <button id="$signup">Sign up</button>
    <button id="$login">Log in</button>
  </tab_launch_>

  <tab_files_ id="$tabFiles">
    <top_bar_>
      <button id="$info"></button>
      <br />
      <button id="$create">Create</button>
      <button id="$edit">Edit</button>
      <button $id="$delete">Delete</button>
    </top_bar_>
    <files_list_>
      <table>
        <tbody id="$filesContainer"></tbody>
        <thead>
          <tr>
            <th width="1"></th>
            <th width="1">ID</th>
            <th>Description</th>
            <th width="80">Size</th>
          </tr>
        </thead>
      </table>
    </files_list_>
  </tab_files_>

  <tab_edit_ id="$tabEdit">
    <top_bar_>
      <button id="$cancel">Cancel</button>
      <span></span>
      <!-- <button id="$upload">Upload</button> -->
      <!-- <span></span> -->
      <!-- <button id="$size">0.32 KiB</button> -->
      <!-- <button id="$meta">Info</button> -->
      <button id="$editCreate">Create</button>
      <!-- <button id="$save">Save</button> -->
    </top_bar_>
    <textarea id="$editText" placeholder="Input content here"></textarea>
  </tab_edit_>

  <tab_settings_ id="$tabSettings">
    <top_bar_>
      <input type="button" value="@ kkocdko" />
      <br />
      <input type="button" value="Create" />
      <input type="button" value="Delete" />
      <span></span>
      <input type="button" value="Settings" />
    </top_bar_>
  </tab_settings_>

  <!-- <prompt_><div>Hello</div></prompt_> -->
</body>

<script>
  // const toBase64 = (arrbuf) => {
  //   // https://stackoverflow.com/a/66046176/11338291
  //   const reader = new FileReader();
  //   const promise = new Promise((r) => (reader.onload = r));
  //   reader.readAsDataURL(new Blob([arrbuf]));
  //   return promise.then(() => reader.result.split(",", 2)[1]);
  // };

  let token;

  const getUpw = async () => {
    const enc = new TextEncoder();
    const data = enc.encode(`paste_${$uid.value}_${$upw.value}`);
    const hash = new Uint8Array(await crypto.subtle.digest("SHA-256", data));
    return hash.reduce((s, v) => s + v.toString(16).padStart(2, "0"), "");
  };

  const msgbox = async (msg) => {
    alert(msg); // TODO: replace to no-blocking dialog
  };

  $signup.onclick = async () => {
    const r = await fetch("/paste", {
      method: "POST",
      headers: {
        op_: "signup",
        uid_: $uid.value,
        upw_: await getUpw(),
        mail_: `${$uid.value}@kkocdko.site`,
        // $mail: $mail.value, // TODO
      },
    });
    const type = r.headers.get("type_");
    if (type !== "ok_default") throw msgbox(type);
    $login.onclick();
  };

  // login without modify the state
  const login = async () => {
    const r = await fetch("/paste", {
      method: "POST",
      headers: { op_: "login", uid_: $uid.value, upw_: await getUpw() },
    });
    const type = r.headers.get("type_");
    if (type !== "ok_default") throw msgbox(type);
    token = r.headers.get("token_");
    // let _level = r.headers.get("level_");
  };

  setInterval(() => {
    login();
  }, 30 * 60 * 1000);

  const friendlySize = (inBytes) =>
    `${Math.ceil((inBytes * 100) / 1024) / 100} KiB`; // TODO
  const fidEnc = (fidNum) => fidNum; // TODO
  const fidDec = (fidNum) => fidNum; // TODO

  const refreshFiles = async () => {
    const r = await fetch("/paste", {
      method: "POST",
      headers: { op_: "list", token_: token },
    });
    const type = r.headers.get("type_");
    if (type !== "ok_default") throw msgbox(JSON.stringify(type));
    let innerHTML = "";
    const handleEntry = (e) => {
      innerHTML += `
        <tr>
          <td><input type="checkbox" /></td>
          <td>${fidEnc(e.fid)}</td>
          <td>${e.desc}</td>
          <td>${friendlySize(e.size)}</td>
        </tr>
      `;
    };
    let e = {};
    for (const line of (await r.text()).split("\n")) {
      // depends on a newline at the end of file!
      if (!line) handleEntry(e), (e = {});
      const [k, v] = line.split(":", 2);
      e[k] = v;
    }
    $filesContainer.innerHTML = innerHTML;
  };

  const switchTab = (target) => {
    for (const el of [$tabLaunch, $tabFiles, $tabEdit, $tabSettings])
      el.removeAttribute("in_");
    target.toggleAttribute("in_");
  };

  $login.onclick = async () => {
    await login();
    $tabLaunch.toggleAttribute("in_");
    $tabFiles.toggleAttribute("in_");
    $info.textContent = "@ " + $uid.value;
    await refreshFiles();
  };

  $create.onclick = async () => {
    switchTab($tabEdit);
  };

  $editText.oninput = () => {
    if ($editText.value.length) $editText.removeAttribute("blank_");
    else $editText.toggleAttribute("blank_");
  };
  $editText.oninput();

  $cancel.onclick = async () => {
    switchTab($tabFiles);
  };

  $editCreate.onclick = async () => {
    const enc = new TextEncoder();
    const body = new Uint8Array(enc.encode($editText.value));
    const r = await fetch("/paste", {
      method: "POST",
      headers: {
        op_: "create",
        token_: token,
        desc_: "default test",
        mime_: "text/plain",
        size_: body.length,
      },
      body,
    });
    const type = r.headers.get("type_");
    if (type !== "ok_default") throw msgbox(type);
    await refreshFiles();
    switchTab($tabFiles);
  };

  $filesContainer.onclick = async ({ target }) => {
    if (target.childElementCount) return;
    if (target instanceof HTMLTableCellElement) target = target.parentNode;
    const r = await fetch("/paste", {
      method: "POST",
      headers: {
        op_: "download",
        token_: token,
        fid_: fidDec(target.children[1].textContent),
      },
    });
    const type = r.headers.get("type_");
    if (type !== "ok_default") throw msgbox(type);
    const body = await r.text();
    switchTab($tabEdit);
    $editText.value = body;
  };
  // setTimeout(() => {
  //   // location.reload();
  // }, 3000);
  // const p = $tr.parentNode;
  // const el = $tr.cloneNode(true);
  // for (let i = 0; i < 99; i++) p.appendChild(el.cloneNode(true));
</script>
